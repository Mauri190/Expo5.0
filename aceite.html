<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador 2D Detallado de Cambio de Aceite</title>
    <style>
        /* Estilos Generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a0000 50%, #330000 100%); /* Fondo negro a rojo oscuro */
            color: #e6e6e6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            max-width: 1200px;
            width: 100%;
        }

        .header {
            text-align: center;
            color: #e6e6e6;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff4d4d, #cc0000); /* Rojo vibrante a rojo oscuro */
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .simulator-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
        }

        .canvas-wrapper {
            flex: 2;
            min-width: 300px;
            background: #1e0000; /* Fondo oscuro para el canvas wrapper */
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #gameCanvas {
            background-color: #330000; /* Fondo del lienzo 2D rojo oscuro */
            border-radius: 10px;
            max-width: 100%;
            height: auto;
            display: block;
            cursor: default; /* Cursor por defecto */
        }

        .controls-panel {
            flex: 1;
            min-width: 280px;
            background: rgba(30, 0, 0, 0.95); /* Panel de control rojo oscuro semi-transparente */
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-section {
            background: rgba(255,0,0,0.05); /* Fondo de secci√≥n rojo muy tenue */
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .panel-section h3 {
            margin-bottom: 10px;
            color: #ff4d4d; /* T√≠tulos de secci√≥n rojos */
            font-size: 1.2rem;
        }

        #currentStepName {
            color: #ff7f7f; /* Nombre del paso actual rojo m√°s claro */
            font-weight: 600;
        }
        
        #currentStepInstructions {
            font-size: 0.95rem;
            opacity: 0.8;
        }

        .tool-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .tool-btn {
            background: linear-gradient(135deg, #cc0000, #800000); /* Botones de herramienta rojo oscuro */
            border: none;
            padding: 12px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
        }

        .tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(204, 0, 0, 0.4); /* Sombra de hover roja */
        }

        .tool-btn.active {
            background: linear-gradient(135deg, #ff4d4d, #ff0000); /* Bot√≥n activo rojo vibrante */
            box-shadow: 0 4px 12px rgba(255, 77, 77, 0.4); /* Sombra de bot√≥n activo roja */
        }

        #feedbackMessage {
            margin-bottom: 10px;
            color: #e6e6e6;
            font-style: italic;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 6px;
            background: rgba(255,0,0,0.03); /* Fondo de estad√≠sticas rojo muy tenue */
            border-radius: 4px;
        }

        .stat-value {
            font-weight: 600;
            color: #ff7f7f; /* Valores de estad√≠sticas rojos */
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000; /* Pantalla de carga negra */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.1);
            border-top: 5px solid #cc0000; /* Loader rojo */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            color: #e6e6e6;
        }

        /* Estilos para el nuevo bot√≥n */
        .back-to-gamification-btn {
            background: linear-gradient(135deg, #cc0000, #800000); /* Bot√≥n "Volver" rojo oscuro */
            border: none;
            padding: 12px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            text-decoration: none; /* Para que no parezca un enlace */
            margin-bottom: 20px; /* Espacio debajo del bot√≥n */
        }

        .back-to-gamification-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(204, 0, 0, 0.4); /* Sombra de hover roja */
        }

        @media (max-width: 768px) {
            .simulator-content {
                flex-direction: column;
                align-items: center;
            }
            .canvas-wrapper, .controls-panel {
                width: 100%;
            }
            .header h1 {
                font-size: 2rem;
            }
            .tool-buttons {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">Cargando Simulador de Cambio de Aceite 2D...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Simulador 2D Detallado de Cambio de Aceite</h1>
            <p>Aprende y practica el cambio de aceite de un veh√≠culo paso a paso en 2D.</p>
        </div>

        <div class="simulator-content">
            <div class="canvas-wrapper">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
            </div>

            <div class="controls-panel">
                <!-- Nuevo bot√≥n "Volver a Gamificaci√≥n" -->
                <a href="gamificacion.php" class="back-to-gamification-btn">Volver a Gamificaci√≥n</a>

                <div class="panel-section step-instructions">
                    <h3>Paso Actual: <span id="currentStepName"></span></h3>
                    <p id="currentStepInstructions"></p>
                </div>

                <div class="panel-section tool-selector">
                    <h3>Seleccionar Herramienta</h3>
                    <div class="tool-buttons">
                        <button class="tool-btn" id="selectWrenchBtn" data-tool="wrench">Llave</button>
                        <button class="tool-btn" id="selectDrainPanBtn" data-tool="drainPan">Bandeja</button>
                        <button class="tool-btn" id="selectFunnelBtn" data-tool="funnel">Embudo</button>
                        <button class="tool-btn" id="selectNewOilBtn" data-tool="newOilBottle">Aceite Nuevo</button>
                        <button class="tool-btn" id="selectNewFilterBtn" data-tool="newOilFilter">Filtro Nuevo</button>
                        <button class="tool-btn" id="selectCarLiftBtn" data-tool="carLift">Elevador</button>
                        <button class="tool-btn" id="resetBtn">Reiniciar</button>
                    </div>
                </div>

                <div class="panel-section feedback-panel">
                    <h3>Estado y Mensajes</h3>
                    <p id="feedbackMessage">¬°Bienvenido al simulador 2D!</p>
                    <div class="stat-item">
                        <span>Tiempo:</span>
                        <span class="stat-value" id="time">00:00</span>
                    </div>
                    <div class="stat-item">
                        <span>Errores:</span>
                        <span class="stat-value" id="errors">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class OilChangeSimulator2D {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.width = this.canvas.width;
                this.height = this.canvas.height;

                // Definici√≥n del coche y sus componentes
                this.car = {
                    x: this.width / 2,
                    y: this.height / 2 + 50,
                    width: 250,
                    height: 90,
                    color: '#cc0000', // Coche rojo
                    isLifted: false,
                    liftHeight: 100, // Altura a la que se levanta el coche
                    originalY: this.height / 2 + 50,
                    wheels: [
                        { xOffset: -90, yOffset: 45, radius: 25 },
                        { xOffset: 90, yOffset: 45, radius: 25 }
                    ]
                };

                this.components = {
                    carBody: { x: this.car.x, y: this.car.y, width: this.car.width, height: this.car.height, name: "Carrocer√≠a", clickable: true },
                    drainPlug: { x: this.car.x + 60, y: this.car.y + this.car.height / 2 + 15, radius: 12, color: '#8b4513', removed: false, clickable: true, name: "Tap√≥n" },
                    oilFilter: { x: this.car.x - 80, y: this.car.y + 25, width: 25, height: 50, color: '#ff0000', removed: false, clickable: true, name: "Filtro" }, // Filtro rojo
                    oilCap: { x: this.car.x + 70, y: this.car.y - this.car.height / 2 - 15, radius: 18, color: '#333333', clickable: true, name: "Tapa" },
                    oilLevelStick: { x: this.car.x + 100, y: this.car.y - this.car.height / 2 - 10, width: 7, height: 40, color: '#ffd700', clickable: true, name: "Varilla" },
                    oilPan: { x: this.car.x, y: this.car.y + this.car.height / 2 - 10, width: 180, height: 30, color: '#555555', name: "C√°rter", clickable: false }
                };

                // Definici√≥n de herramientas
                this.tools = {
                    wrench: { name: "Llave", active: false, color: '#888888', icon: 'üîß' },
                    drainPan: { name: "Bandeja", active: false, placed: false, x: this.car.x, y: this.car.y + this.car.height / 2 + 60, width: 120, height: 30, color: '#555555', icon: 'üõ¢Ô∏è' },
                    funnel: { name: "Embudo", active: false, placed: false, x: this.components.oilCap.x, y: this.components.oilCap.y - 40, width: 40, height: 50, color: '#aaaaaa', icon: ' funnel' },
                    newOilBottle: { name: "Aceite Nuevo", active: false, color: '#00ff00', icon: 'üß¥' },
                    newOilFilter: { name: "Filtro Nuevo", active: false, color: '#ff0000', icon: '‚öôÔ∏è' }, // Filtro nuevo rojo
                    carLift: { name: "Elevador", active: false, color: '#cc0000', icon: '‚¨ÜÔ∏è‚¨áÔ∏è' } // Elevador rojo
                };
                this.activeTool = null;

                // L√≥gica de Pasos
                this.currentStepIndex = 0;
                this.steps = [
                    { name: "Preparaci√≥n: Levantar el Coche", instructions: "Selecciona el 'Elevador' y haz clic en la 'Carrocer√≠a' para levantarlo y acceder a la parte inferior.", target: 'carBody', tool: 'carLift' },
                    { name: "Drenar Aceite (Paso 1/3): Colocar Bandeja", instructions: "Selecciona la 'Bandeja' y haz clic en el suelo debajo del 'Tap√≥n' para recoger el aceite usado.", target: 'groundUnderCar', tool: 'drainPan' },
                    { name: "Drenar Aceite (Paso 2/3): Quitar Tap√≥n", instructions: "Selecciona la 'Llave' y haz clic en el 'Tap√≥n' del c√°rter para aflojarlo y quitarlo. ¬°El aceite comenzar√° a salir!", target: 'drainPlug', tool: 'wrench' },
                    { name: "Drenar Aceite (Paso 3/3): Esperar Drenaje", instructions: "Espera a que todo el aceite viejo se drene completamente en la bandeja. Esto puede tomar unos segundos.", target: 'drainPanObject', tool: null }, // Target visual para el drenaje
                    { name: "Cambiar Filtro (Paso 1/2): Quitar Filtro Viejo", instructions: "Una vez drenado el aceite, selecciona la 'Llave' y haz clic en el 'Filtro' para desenroscarlo y quitarlo.", target: 'oilFilter', tool: 'wrench' },
                    { name: "Cambiar Filtro (Paso 2/2): Instalar Filtro Nuevo", instructions: "Selecciona el 'Filtro Nuevo' y haz clic en el lugar donde estaba el filtro viejo para instalarlo. Aseg√∫rate de apretarlo a mano.", target: 'oilFilterArea', tool: 'newOilFilter' },
                    { name: "Poner Tap√≥n de Drenaje", instructions: "Selecciona la 'Llave' y haz clic en el agujero del 'C√°rter' para volver a poner el 'Tap√≥n'. Apri√©talo firmemente.", target: 'drainPlugArea', tool: 'wrench' },
                    { name: "A√±adir Aceite (Paso 1/2): Colocar Embudo", instructions: "Selecciona el 'Embudo' y haz clic en la 'Tapa' del motor para colocarlo. Esto evitar√° derrames.", target: 'oilCap', tool: 'funnel' },
                    { name: "A√±adir Aceite (Paso 2/2): Verter Aceite Nuevo", instructions: "Selecciona 'Aceite Nuevo' y haz clic en el 'Embudo' para verter el aceite fresco en el motor. Consulta el manual para la cantidad correcta.", target: 'funnelObject', tool: 'newOilBottle' },
                    { name: "Verificar Nivel de Aceite", instructions: "Retira el embudo. Haz clic en la 'Varilla' para sacarla, limpiarla, volver a insertarla y sacarla de nuevo para verificar que el nivel de aceite sea el correcto.", target: 'oilLevelStick', tool: null },
                    { name: "Finalizar: Bajar el Coche", instructions: "Selecciona el 'Elevador' y haz clic en la 'Carrocer√≠a' para bajarlo a su posici√≥n original. ¬°Has completado el cambio de aceite con √©xito!", target: 'carBody', tool: 'carLift' },
                    { name: "¬°Completado!", instructions: "¬°Felicidades! Has realizado un cambio de aceite completo. Recuerda desechar el aceite usado de forma responsable.", target: null, tool: null }
                ];

                // Estado del Veh√≠culo
                this.carState = {
                    isLifted: false,
                    drainPanPlaced: false,
                    drainPlugRemoved: false,
                    oilDrained: false,
                    oldFilterRemoved: false,
                    newFilterInstalled: false,
                    funnelPlaced: false,
                    newOilAdded: false,
                    oilLevelChecked: false
                };

                // Estad√≠sticas
                this.stats = {
                    time: 0,
                    errors: 0
                };
                this.timerInterval = null;
                this.animationFrameId = null; // Para controlar requestAnimationFrame
                this.hoveredObject = null; // Objeto sobre el que el rat√≥n est√° actualmente

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateUI();
                this.draw();
                this.startTimer();

                setTimeout(() => {
                    document.querySelector('.loading-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.querySelector('.loading-screen').style.display = 'none';
                    }, 500);
                }, 1000);
            }

            startTimer() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => {
                    if (this.currentStepIndex < this.steps.length - 1) {
                        this.stats.time++;
                        this.updateUI();
                    } else {
                        clearInterval(this.timerInterval);
                    }
                }, 1000);
            }

            setupEventListeners() {
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (btn.id === 'resetBtn') {
                            this.resetSimulator();
                        } else {
                            this.setActiveTool(btn.dataset.tool);
                        }
                    });
                });

                this.canvas.addEventListener('click', (e) => this.onCanvasClick(e));
                this.canvas.addEventListener('mousemove', (e) => this.onCanvasMouseMove(e));
                this.canvas.addEventListener('mouseout', () => {
                    this.hoveredObject = null;
                    this.canvas.style.cursor = 'default';
                    this.draw();
                });
                window.addEventListener('resize', () => this.handleResize());
            }

            handleResize() {
                this.draw();
            }

            setActiveTool(toolName) {
                this.activeTool = toolName;
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tool === toolName) {
                        btn.classList.add('active');
                    }
                });
                this.updateFeedback(`Herramienta seleccionada: ${this.tools[toolName].name}`);
                this.draw();
            }

            onCanvasMouseMove(event) {
                const rect = this.canvas.getBoundingClientRect();
                const mouseX = event.clientX - rect.left;
                const mouseY = event.clientY - rect.top;

                let newHoveredObject = null;
                let cursorChanged = false;

                const currentStep = this.steps[this.currentStepIndex];
                const targetName = currentStep.target;
                const requiredTool = currentStep.tool;

                // Check car body
                if (this.isClickingCar(mouseX, mouseY)) {
                    newHoveredObject = this.components.carBody;
                }
                // Check drain plug
                if (this.isClickingComponent(mouseX, mouseY, this.components.drainPlug) && !this.components.drainPlug.removed) {
                    newHoveredObject = this.components.drainPlug;
                }
                // Check oil filter
                if (this.isClickingComponent(mouseX, mouseY, this.components.oilFilter) && !this.components.oilFilter.removed) {
                    newHoveredObject = this.components.oilFilter;
                }
                // Check oil cap
                if (this.isClickingComponent(mouseX, mouseY, this.components.oilCap)) {
                    newHoveredObject = this.components.oilCap;
                }
                // Check oil level stick
                if (this.isClickingComponent(mouseX, mouseY, this.components.oilLevelStick)) {
                    newHoveredObject = this.components.oilLevelStick;
                }
                // Check drain pan (if placed)
                if (this.tools.drainPan.placed && this.isClickingComponent(mouseX, mouseY, this.tools.drainPan)) {
                    newHoveredObject = this.tools.drainPan;
                }
                // Check funnel (if placed)
                if (this.tools.funnel.placed && this.isClickingComponent(mouseX, mouseY, this.tools.funnel)) {
                    newHoveredObject = this.tools.funnel;
                }
                // Check ground under car (for drain pan placement)
                if (targetName === 'groundUnderCar' && this.isClickingGroundUnderCar(mouseX, mouseY)) {
                    newHoveredObject = { name: "Suelo bajo el coche", x: this.car.x, y: this.car.y + this.car.height / 2 + 20, width: this.car.width * 0.8, height: 50 };
                }
                // Check filter area (for new filter installation)
                if (targetName === 'oilFilterArea' && this.isClickingFilterArea(mouseX, mouseY)) {
                    newHoveredObject = { name: "√Årea del Filtro", x: this.components.oilFilter.x, y: this.components.oilFilter.y, width: this.components.oilFilter.width, height: this.components.oilFilter.height };
                }
                // Check drain plug area (for re-installation)
                if (targetName === 'drainPlugArea' && this.isClickingDrainPlugArea(mouseX, mouseY)) {
                    newHoveredObject = { name: "√Årea del Tap√≥n", x: this.components.drainPlug.x, y: this.components.drainPlug.y, radius: this.components.drainPlug.radius };
                }

                this.hoveredObject = newHoveredObject;

                // Change cursor if it's the correct target and tool
                if (this.hoveredObject) {
                    let isCorrectTarget = false;
                    if (this.hoveredObject.name === this.components[targetName]?.name ||
                        (targetName === 'carBody' && this.hoveredObject.name === this.components.carBody.name) ||
                        (targetName === 'drainPanObject' && this.hoveredObject.name === this.tools.drainPan.name) ||
                        (targetName === 'funnelObject' && this.hoveredObject.name === this.tools.funnel.name) ||
                        (targetName === 'groundUnderCar' && this.hoveredObject.name === "Suelo bajo el coche") ||
                        (targetName === 'oilFilterArea' && this.hoveredObject.name === "√Årea del Filtro") ||
                        (targetName === 'drainPlugArea' && this.hoveredObject.name === "√Årea del Tap√≥n")
                    ) {
                        isCorrectTarget = true;
                    }

                    const isCorrectTool = (requiredTool === null || this.activeTool === requiredTool);

                    if (isCorrectTarget && isCorrectTool) {
                        this.canvas.style.cursor = 'pointer';
                        cursorChanged = true;
                    }
                }

                if (!cursorChanged) {
                    this.canvas.style.cursor = 'default';
                }
                this.draw();
            }

            onCanvasClick(event) {
                const rect = this.canvas.getBoundingClientRect();
                const mouseX = event.clientX - rect.left;
                const mouseY = event.clientY - rect.top;

                const currentStep = this.steps[this.currentStepIndex];
                const targetName = currentStep.target;
                const requiredTool = currentStep.tool;

                let clickedObject = null;

                // Determine which object was clicked
                if (this.isClickingCar(mouseX, mouseY)) {
                    clickedObject = this.components.carBody;
                } else if (this.isClickingComponent(mouseX, mouseY, this.components.drainPlug) && !this.components.drainPlug.removed) {
                    clickedObject = this.components.drainPlug;
                } else if (this.isClickingComponent(mouseX, mouseY, this.components.oilFilter) && !this.components.oilFilter.removed) {
                    clickedObject = this.components.oilFilter;
                } else if (this.isClickingComponent(mouseX, mouseY, this.components.oilCap)) {
                    clickedObject = this.components.oilCap;
                } else if (this.isClickingComponent(mouseX, mouseY, this.components.oilLevelStick)) {
                    clickedObject = this.components.oilLevelStick;
                } else if (this.tools.drainPan.placed && this.isClickingComponent(mouseX, mouseY, this.tools.drainPan)) {
                    clickedObject = this.tools.drainPan;
                } else if (this.tools.funnel.placed && this.isClickingComponent(mouseX, mouseY, this.tools.funnel)) {
                    clickedObject = this.tools.funnel;
                } else if (this.isClickingGroundUnderCar(mouseX, mouseY)) {
                    clickedObject = { name: "Suelo bajo el coche" }; // Placeholder for ground interaction
                } else if (this.isClickingFilterArea(mouseX, mouseY)) {
                    clickedObject = { name: "√Årea del Filtro" }; // Placeholder for filter area interaction
                } else if (this.isClickingDrainPlugArea(mouseX, mouseY)) {
                    clickedObject = { name: "√Årea del Tap√≥n" }; // Placeholder for drain plug area interaction
                }

                if (!clickedObject) {
                    this.showError("Haz clic en el elemento correcto para el paso actual.");
                    return;
                }

                // Validate tool and target
                let isCorrectTarget = false;
                if (clickedObject.name === this.components[targetName]?.name ||
                    (targetName === 'carBody' && clickedObject.name === this.components.carBody.name) ||
                    (targetName === 'drainPanObject' && clickedObject.name === this.tools.drainPan.name) ||
                    (targetName === 'funnelObject' && clickedObject.name === this.tools.funnel.name) ||
                    (targetName === 'groundUnderCar' && clickedObject.name === "Suelo bajo el coche") ||
                    (targetName === 'oilFilterArea' && clickedObject.name === "√Årea del Filtro") ||
                    (targetName === 'drainPlugArea' && clickedObject.name === "√Årea del Tap√≥n")
                ) {
                    isCorrectTarget = true;
                }

                const isCorrectTool = (requiredTool === null || this.activeTool === requiredTool);

                if (!isCorrectTarget) {
                    this.showError(`Necesitas interactuar con ${this.steps[this.currentStepIndex].instructions.split('haz clic en ')[1].split(' para')[0]}.`);
                    return;
                }
                if (!isCorrectTool) {
                    this.showError(`Necesitas seleccionar la herramienta '${this.tools[requiredTool].name}' para este paso.`);
                    return;
                }

                // Proceed with interaction
                this.handleInteraction(clickedObject.name);
                this.draw();
            }

            // --- Funciones de detecci√≥n de clic ---
            isClickingCar(mouseX, mouseY) {
                const carTopY = this.car.y - this.car.height / 2;
                const carBottomY = this.car.y + this.car.height / 2;
                const carLeftX = this.car.x - this.car.width / 2;
                const carRightX = this.car.x + this.car.width / 2;

                return mouseX > carLeftX && mouseX < carRightX &&
                       mouseY > carTopY && mouseY < carBottomY;
            }

            isClickingComponent(mouseX, mouseY, component) {
                if (!component.clickable) return false;

                if (component.radius) { // Es un c√≠rculo (tap√≥n, tapa de aceite)
                    const dist = Math.sqrt(Math.pow(mouseX - component.x, 2) + Math.pow(mouseY - component.y, 2));
                    return dist < component.radius;
                } else if (component.width && component.height) { // Es un rect√°ngulo (filtro, bandeja, embudo, varilla)
                    const compLeftX = component.x - component.width / 2;
                    const compRightX = component.x + component.width / 2;
                    const compTopY = component.y - component.height / 2;
                    const compBottomY = component.y + component.height / 2;

                    return mouseX > compLeftX && mouseX < compRightX &&
                           mouseY > compTopY && mouseY < compBottomY;
                }
                return false;
            }

            isClickingGroundUnderCar(mouseX, mouseY) {
                // Define un √°rea debajo del coche donde se puede colocar la bandeja
                const groundAreaY = this.car.y + this.car.height / 2 + 20; // Un poco debajo del coche
                const groundAreaHeight = 50;
                const groundAreaWidth = this.car.width * 0.8; // Un poco m√°s estrecho que el coche
                const groundAreaX = this.car.x - groundAreaWidth / 2;

                return mouseX > groundAreaX && mouseX < groundAreaX + groundAreaWidth &&
                       mouseY > groundAreaY && mouseY < groundAreaY + groundAreaHeight;
            }

            isClickingFilterArea(mouseX, mouseY) {
                // √Årea donde se instala el filtro (donde estaba el viejo)
                const filterArea = {
                    x: this.components.oilFilter.x,
                    y: this.components.oilFilter.y,
                    width: this.components.oilFilter.width,
                    height: this.components.oilFilter.height
                };
                const compLeftX = filterArea.x - filterArea.width / 2;
                const compRightX = filterArea.x + filterArea.width / 2;
                const compTopY = filterArea.y - filterArea.height / 2;
                const compBottomY = filterArea.y + filterArea.height / 2;

                return mouseX > compLeftX && mouseX < compRightX &&
                       mouseY > compTopY && mouseY < compBottomY;
            }

            isClickingDrainPlugArea(mouseX, mouseY) {
                // √Årea donde se instala el tap√≥n de drenaje (donde estaba el viejo)
                const plugArea = {
                    x: this.components.drainPlug.x,
                    y: this.components.drainPlug.y,
                    radius: this.components.drainPlug.radius
                };
                const dist = Math.sqrt(Math.pow(mouseX - plugArea.x, 2) + Math.pow(mouseY - plugArea.y, 2));
                return dist < plugArea.radius * 1.5; // Un poco m√°s grande para facilitar el clic
            }

            handleInteraction(objectName) {
                switch (this.currentStepIndex) {
                    case 0: // Lift Car
                        if (objectName === this.components.carBody.name && this.activeTool === 'carLift') {
                            this.liftCar();
                        } else {
                            this.showError("Necesitas seleccionar el 'Elevador' y hacer clic en la 'Carrocer√≠a' para levantarlo.");
                        }
                        break;
                    case 1: // Place Drain Pan
                        if (objectName === "Suelo bajo el coche" && this.activeTool === 'drainPan' && this.carState.isLifted) {
                            this.placeDrainPan();
                        } else {
                            this.showError("Selecciona la 'Bandeja' y haz clic en el suelo debajo del coche.");
                        }
                        break;
                    case 2: // Remove Drain Plug
                        if (objectName === this.components.drainPlug.name && this.activeTool === 'wrench' && this.carState.drainPanPlaced) {
                            this.removeDrainPlug();
                        } else {
                            this.showError("Selecciona la 'Llave' y haz clic en el 'Tap√≥n'.");
                        }
                        break;
                    case 3: // Wait for Oil Drain (no direct interaction, just waiting)
                        this.updateFeedback("El aceite se est√° drenando. Por favor, espera.");
                        break;
                    case 4: // Remove Oil Filter
                        if (objectName === this.components.oilFilter.name && this.activeTool === 'wrench' && this.carState.oilDrained) {
                            this.removeOilFilter();
                        } else {
                            this.showError("Selecciona la 'Llave' y haz clic en el 'Filtro'.");
                        }
                        break;
                    case 5: // Install New Oil Filter
                        if (objectName === "√Årea del Filtro" && this.activeTool === 'newOilFilter' && this.carState.oldFilterRemoved) {
                            this.installNewOilFilter();
                        } else {
                            this.showError("Selecciona el 'Filtro Nuevo' y haz clic en el lugar del filtro.");
                        }
                        break;
                    case 6: // Install Drain Plug
                        if (objectName === "√Årea del Tap√≥n" && this.activeTool === 'wrench' && this.carState.newFilterInstalled) {
                            this.installDrainPlug();
                        } else {
                            this.showError("Selecciona la 'Llave' y haz clic en el agujero del c√°rter.");
                        }
                        break;
                    case 7: // Place Funnel
                        if (objectName === this.components.oilCap.name && this.activeTool === 'funnel') {
                            this.placeFunnel();
                        } else {
                            this.showError("Selecciona el 'Embudo' y haz clic en la 'Tapa'.");
                        }
                        break;
                    case 8: // Add New Oil
                        if (objectName === this.tools.funnel.name && this.activeTool === 'newOilBottle' && this.carState.funnelPlaced) {
                            this.addOil();
                        } else {
                            this.showError("Selecciona 'Aceite Nuevo' y haz clic en el 'Embudo'.");
                        }
                        break;
                    case 9: // Check Oil Level
                        if (objectName === this.components.oilLevelStick.name && this.carState.newOilAdded) {
                            this.checkOilLevel();
                        } else {
                            this.showError("Haz clic en la 'Varilla' para verificar el aceite.");
                        }
                        break;
                    case 10: // Lower Car
                        if (objectName === this.components.carBody.name && this.activeTool === 'carLift' && this.carState.oilLevelChecked) {
                            this.lowerCar();
                        } else {
                            this.showError("Selecciona el 'Elevador' y haz clic en la 'Carrocer√≠a' para bajarlo.");
                        }
                        break;
                    default:
                        this.updateFeedback("El proceso ha terminado.");
                        break;
                }
            }

            // --- L√≥gica de Pasos ---
            liftCar() {
                if (!this.carState.isLifted) {
                    this.updateFeedback("Levantando el coche...");
                    this.animateCarLift(true, () => {
                        this.carState.isLifted = true;
                        this.updateFeedback("Coche levantado.");
                        this.nextStep();
                    });
                }
            }

            lowerCar() {
                if (this.carState.isLifted) {
                    this.updateFeedback("Bajando el coche...");
                    this.animateCarLift(false, () => {
                        this.carState.isLifted = false;
                        this.updateFeedback("Coche bajado. ¬°Cambio de aceite completado!");
                        this.nextStep();
                    });
                }
            }

            animateCarLift(liftUp, callback) {
                const startY = this.car.y;
                const endY = liftUp ? this.car.originalY - this.car.liftHeight : this.car.originalY;
                const duration = 1000; // ms
                const startTime = performance.now();

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easedProgress = 0.5 - 0.5 * Math.cos(progress * Math.PI); // Easing suave

                    const newCarY = startY + (endY - startY) * easedProgress;
                    const deltaY = newCarY - this.car.y;
                    this.car.y = newCarY;

                    // Mover componentes y herramientas junto con el coche
                    this.components.carBody.y += deltaY;
                    for (const key in this.components) {
                        if (key !== 'carBody') { // CarBody ya se actualiz√≥
                            this.components[key].y += deltaY;
                        }
                    }
                    this.car.wheels.forEach(wheel => wheel.yOffset += deltaY); // Actualizar offset de ruedas
                    this.tools.drainPan.y += deltaY;
                    this.tools.funnel.y += deltaY;

                    this.draw();

                    if (progress < 1) {
                        this.animationFrameId = requestAnimationFrame(animate);
                    } else {
                        if (callback) callback();
                    }
                };
                this.animationFrameId = requestAnimationFrame(animate);
            }

            placeDrainPan() {
                if (!this.carState.drainPanPlaced && this.carState.isLifted) {
                    this.updateFeedback("Colocando la bandeja...");
                    this.tools.drainPan.placed = true;
                    this.tools.drainPan.x = this.car.x; // Centrar debajo del coche
                    this.tools.drainPan.y = this.car.y + this.car.height / 2 + 20; // Posici√≥n debajo del coche levantado
                    setTimeout(() => {
                        this.updateFeedback("Bandeja colocada.");
                        this.carState.drainPanPlaced = true;
                        this.nextStep();
                        this.draw();
                    }, 1000);
                }
            }

            removeDrainPlug() {
                if (!this.carState.drainPlugRemoved && this.carState.drainPanPlaced) {
                    this.updateFeedback("Quitando el tap√≥n...");
                    this.components.drainPlug.removed = true;
                    setTimeout(() => {
                        this.updateFeedback("Tap√≥n quitado. ¬°El aceite est√° drenando!");
                        this.carState.drainPlugRemoved = true;
                        this.nextStep(); // Avanza al paso de "Esperar Drenaje"
                        this.draw();
                        this.drainOilAnimation(); // Inicia la animaci√≥n de drenaje
                    }, 500);
                }
            }

            drainOilAnimation() {
                let oilLevel = 0; // Representa la cantidad de aceite en la bandeja
                const maxOilLevel = this.tools.drainPan.height * 0.6;
                const drainDuration = 3000; // ms
                const startTime = performance.now();

                const animateDrain = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / drainDuration, 1);
                    oilLevel = maxOilLevel * progress;

                    this.draw(oilLevel); // Pasa el nivel de aceite para dibujarlo

                    if (progress < 1) {
                        this.animationFrameId = requestAnimationFrame(animateDrain);
                    } else {
                        this.carState.oilDrained = true;
                        this.updateFeedback("Aceite viejo drenado completamente.");
                        this.nextStep(); // Avanza al siguiente paso despu√©s del drenaje
                        this.draw();
                    }
                };
                this.animationFrameId = requestAnimationFrame(animateDrain);
            }

            removeOilFilter() {
                if (!this.carState.oldFilterRemoved && this.carState.oilDrained) {
                    this.updateFeedback("Quitando el filtro viejo...");
                    this.components.oilFilter.removed = true;
                    setTimeout(() => {
                        this.updateFeedback("Filtro viejo quitado.");
                        this.carState.oldFilterRemoved = true;
                        this.nextStep();
                        this.draw();
                    }, 700);
                }
            }

            installNewOilFilter() {
                if (this.carState.oldFilterRemoved && !this.carState.newFilterInstalled) {
                    this.updateFeedback("Instalando el nuevo filtro...");
                    this.components.oilFilter.removed = false; // El nuevo filtro ocupa su lugar
                    this.components.oilFilter.color = this.tools.newOilFilter.color; // Cambiar color a "nuevo"
                    setTimeout(() => {
                        this.updateFeedback("Nuevo filtro instalado.");
                        this.carState.newFilterInstalled = true;
                        this.nextStep();
                        this.draw();
                    }, 700);
                }
            }

            installDrainPlug() {
                if (this.carState.drainPlugRemoved && this.carState.newFilterInstalled) {
                    this.updateFeedback("Volviendo a poner el tap√≥n...");
                    this.components.drainPlug.removed = false;
                    setTimeout(() => {
                        this.updateFeedback("Tap√≥n instalado.");
                        this.carState.drainPlugRemoved = false; // El tap√≥n est√° de vuelta
                        this.nextStep();
                        this.draw();
                    }, 500);
                }
            }

            placeFunnel() {
                if (!this.carState.funnelPlaced) {
                    this.updateFeedback("Colocando el embudo...");
                    this.tools.funnel.placed = true;
                    this.tools.funnel.x = this.components.oilCap.x;
                    this.tools.funnel.y = this.components.oilCap.y - 40; // Posici√≥n sobre la tapa de aceite
                    setTimeout(() => {
                        this.updateFeedback("Embudo colocado.");
                        this.carState.funnelPlaced = true;
                        this.nextStep();
                        this.draw();
                    }, 1000);
                }
            }

            addOil() {
                if (this.carState.funnelPlaced && !this.carState.newOilAdded) {
                    this.updateFeedback("A√±adiendo aceite nuevo...");
                    this.animateOilFill(() => {
                        this.carState.newOilAdded = true;
                        this.updateFeedback("Aceite nuevo a√±adido.");
                        this.tools.funnel.placed = false; // Quitar el embudo
                        this.nextStep();
                        this.draw();
                    });
                }
            }

            animateOilFill(callback) {
                let fillLevel = 0; // Representa el nivel de aceite en el motor (visual)
                const maxFillLevel = this.components.oilPan.height * 0.8; // Altura visual del aceite
                const fillDuration = 2000; // ms
                const startTime = performance.now();

                const animateFill = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / fillDuration, 1);
                    fillLevel = maxFillLevel * progress;

                    this.draw(null, fillLevel); // Pasa el nivel de llenado para dibujarlo

                    if (progress < 1) {
                        this.animationFrameId = requestAnimationFrame(animateFill);
                    } else {
                        if (callback) callback();
                    }
                };
                this.animationFrameId = requestAnimationFrame(animateFill);
            }

            checkOilLevel() {
                if (!this.carState.oilLevelChecked && this.carState.newOilAdded) {
                    this.updateFeedback("Verificando el nivel de aceite... (sacando varilla)");
                    // Animaci√≥n de sacar y meter la varilla
                    const originalStickY = this.components.oilLevelStick.y;
                    const pulledStickY = originalStickY - 50;
                    const duration = 500;

                    const animatePull = (currentTime) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        const easedProgress = 0.5 - 0.5 * Math.cos(progress * Math.PI);

                        this.components.oilLevelStick.y = originalStickY + (pulledStickY - originalStickY) * easedProgress;
                        this.draw();

                        if (progress < 1) {
                            this.animationFrameId = requestAnimationFrame(animatePull);
                        } else {
                            this.updateFeedback("Nivel de aceite correcto. (Volviendo a insertar varilla)");
                            setTimeout(() => {
                                this.components.oilLevelStick.y = originalStickY; // Vuelve a su posici√≥n
                                this.draw();
                                this.carState.oilLevelChecked = true;
                                this.nextStep();
                            }, 1000);
                        }
                    };
                    const startTime = performance.now();
                    this.animationFrameId = requestAnimationFrame(animatePull);
                }
            }

            nextStep() {
                if (this.currentStepIndex < this.steps.length - 1) {
                    this.currentStepIndex++;
                    this.updateUI();
                }
            }

            updateUI() {
                const stepInfo = this.steps[this.currentStepIndex];
                document.getElementById('currentStepName').textContent = stepInfo.name;
                document.getElementById('currentStepInstructions').textContent = stepInfo.instructions;
                document.getElementById('time').textContent =
                    Math.floor(this.stats.time / 60) + ':' +
                    (Math.floor(this.stats.time % 60)).toString().padStart(2, '0');
                document.getElementById('errors').textContent = this.stats.errors;
            }

            updateFeedback(message) {
                document.getElementById('feedbackMessage').textContent = message;
            }

            showError(message) {
                this.stats.errors++;
                this.updateUI();
                this.updateFeedback(`Error: ${message}`);
            }

            resetSimulator() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                if (this.animationFrameId) cancelAnimationFrame(this.animationFrameId);

                // Restablecer todas las propiedades a sus valores iniciales
                this.car = {
                    x: this.width / 2,
                    y: this.height / 2 + 50,
                    width: 250,
                    height: 90,
                    color: '#cc0000', // Coche rojo
                    isLifted: false,
                    liftHeight: 100,
                    originalY: this.height / 2 + 50,
                    wheels: [
                        { xOffset: -90, yOffset: 45, radius: 25 },
                        { xOffset: 90, yOffset: 45, radius: 25 }
                    ]
                };
                this.components = {
                    carBody: { x: this.car.x, y: this.car.y, width: this.car.width, height: this.car.height, name: "Carrocer√≠a", clickable: true },
                    drainPlug: { x: this.car.x + 60, y: this.car.y + this.car.height / 2 + 15, radius: 12, color: '#8b4513', removed: false, clickable: true, name: "Tap√≥n" },
                    oilFilter: { x: this.car.x - 80, y: this.car.y + 25, width: 25, height: 50, color: '#ff0000', removed: false, clickable: true, name: "Filtro" }, // Filtro rojo
                    oilCap: { x: this.car.x + 70, y: this.car.y - this.car.height / 2 - 15, radius: 18, color: '#333333', clickable: true, name: "Tapa" },
                    oilLevelStick: { x: this.car.x + 100, y: this.car.y - this.car.height / 2 - 10, width: 7, height: 40, color: '#ffd700', clickable: true, name: "Varilla" },
                    oilPan: { x: this.car.x, y: this.car.y + this.car.height / 2 - 10, width: 180, height: 30, color: '#555555', name: "C√°rter", clickable: false }
                };
                this.tools = {
                    wrench: { name: "Llave", active: false, color: '#888888', icon: 'üîß' },
                    drainPan: { name: "Bandeja", active: false, placed: false, x: this.car.x, y: this.car.y + this.car.height / 2 + 60, width: 120, height: 30, color: '#555555', icon: 'üõ¢Ô∏è' },
                    funnel: { name: "Embudo", active: false, placed: false, x: this.components.oilCap.x, y: this.components.oilCap.y - 40, width: 40, height: 50, color: '#aaaaaa', icon: ' funnel' },
                    newOilBottle: { name: "Aceite Nuevo", active: false, color: '#00ff00', icon: 'üß¥' },
                    newOilFilter: { name: "Filtro Nuevo", active: false, color: '#ff0000', icon: '‚öôÔ∏è' }, // Filtro nuevo rojo
                    carLift: { name: "Elevador", active: false, color: '#cc0000', icon: '‚¨ÜÔ∏è‚¨áÔ∏è' } // Elevador rojo
                };
                this.activeTool = null;
                this.currentStepIndex = 0;
                this.carState = {
                    isLifted: false,
                    drainPanPlaced: false,
                    drainPlugRemoved: false,
                    oilDrained: false,
                    oldFilterRemoved: false,
                    newFilterInstalled: false,
                    funnelPlaced: false,
                    newOilAdded: false,
                    oilLevelChecked: false
                };
                this.stats = { time: 0, errors: 0 };
                this.hoveredObject = null;

                this.updateUI();
                this.updateFeedback("Simulador reiniciado. ¬°Comienza de nuevo!");
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                this.draw();
                this.startTimer();
            }

            // --- Funciones de Dibujo ---
            draw(oilDrainingLevel = 0, oilFillLevel = 0) {
                this.ctx.clearRect(0, 0, this.width, this.height);

                const currentStep = this.steps[this.currentStepIndex];
                const targetName = currentStep.target;
                const requiredTool = currentStep.tool;

                // Dibujar el suelo
                this.ctx.fillStyle = '#444444';
                this.ctx.fillRect(0, this.height - 50, this.width, 50);

                // Dibujar el elevador si el coche est√° levantado
                if (this.car.isLifted) {
                    this.ctx.fillStyle = '#cc0000'; // Elevador rojo
                    this.ctx.fillRect(this.car.x - 100, this.car.y + this.car.height / 2 + 5, 200, 10); // Base del elevador
                    this.ctx.fillRect(this.car.x - 90, this.car.y + this.car.height / 2 + 15, 10, this.car.originalY - (this.car.y + this.car.height / 2 + 15)); // Pata izquierda
                    this.ctx.fillRect(this.car.x + 80, this.car.y + this.car.height / 2 + 15, 10, this.car.originalY - (this.car.y + this.car.height / 2 + 15)); // Pata derecha
                }

                // Dibujar el coche
                this.ctx.fillStyle = this.car.color;
                this.ctx.fillRect(this.car.x - this.car.width / 2, this.car.y - this.car.height / 2, this.car.width, this.car.height);

                // Dibujar techo del coche
                this.ctx.fillStyle = '#800000'; // Techo rojo oscuro
                this.ctx.fillRect(this.car.x - this.car.width / 2 + 50, this.car.y - this.car.height / 2 - 30, this.car.width - 100, 40);

                // Dibujar ruedas
                this.ctx.fillStyle = '#1a1a1a';
                this.car.wheels.forEach(wheel => {
                    this.ctx.beginPath();
                    this.ctx.arc(this.car.x + wheel.xOffset, this.car.y + wheel.yOffset, wheel.radius, 0, Math.PI * 2);
                    this.ctx.fill();
                });

                // Dibujar c√°rter de aceite
                this.ctx.fillStyle = this.components.oilPan.color;
                this.ctx.fillRect(this.components.oilPan.x - this.components.oilPan.width / 2, this.components.oilPan.y - this.components.oilPan.height / 2, this.components.oilPan.width, this.components.oilPan.height);

                // Dibujar componentes del coche
                // Tap√≥n de drenaje
                if (!this.components.drainPlug.removed) {
                    this.ctx.fillStyle = this.components.drainPlug.color;
                    this.ctx.beginPath();
                    this.ctx.arc(this.components.drainPlug.x, this.components.drainPlug.y, this.components.drainPlug.radius, 0, Math.PI * 2);
                    this.ctx.fill();
                } else {
                    // Indicar el agujero si el tap√≥n est√° quitado
                    this.ctx.fillStyle = '#222222';
                    this.ctx.beginPath();
                    this.ctx.arc(this.components.drainPlug.x, this.components.drainPlug.y, this.components.drainPlug.radius * 0.8, 0, Math.PI * 2);
                    this.ctx.fill();
                }

                // Filtro de aceite
                if (!this.components.oilFilter.removed) {
                    this.ctx.fillStyle = this.components.oilFilter.color;
                    this.ctx.fillRect(this.components.oilFilter.x - this.components.oilFilter.width / 2, this.components.oilFilter.y - this.components.oilFilter.height / 2, this.components.oilFilter.width, this.components.oilFilter.height);
                } else {
                    // Indicar el espacio del filtro si est√° quitado
                    this.ctx.strokeStyle = '#aaaaaa';
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeRect(this.components.oilFilter.x - this.components.oilFilter.width / 2, this.components.oilFilter.y - this.components.oilFilter.height / 2, this.components.oilFilter.width, this.components.oilFilter.height);
                }

                // Tapa de llenado de aceite
                this.ctx.fillStyle = this.components.oilCap.color;
                this.ctx.beginPath();
                this.ctx.arc(this.components.oilCap.x, this.components.oilCap.y, this.components.oilCap.radius, 0, Math.PI * 2);
                this.ctx.fill();

                // Varilla de nivel de aceite
                this.ctx.fillStyle = this.components.oilLevelStick.color;
                this.ctx.fillRect(this.components.oilLevelStick.x - this.components.oilLevelStick.width / 2, this.components.oilLevelStick.y - this.components.oilLevelStick.height / 2, this.components.oilLevelStick.width, this.components.oilLevelStick.height);

                // Dibujar herramientas si est√°n activas o colocadas
                // Bandeja de drenaje
                if (this.tools.drainPan.placed) {
                    this.ctx.fillStyle = this.tools.drainPan.color;
                    this.ctx.fillRect(this.tools.drainPan.x - this.tools.drainPan.width / 2, this.tools.drainPan.y - this.tools.drainPan.height / 2, this.tools.drainPan.width, this.tools.drainPan.height);
                    
                    // Simular aceite drenando en la bandeja
                    if (this.carState.drainPlugRemoved && !this.carState.oilDrained) {
                        this.ctx.fillStyle = 'rgba(255, 165, 0, 0.7)'; // Color de aceite
                        this.ctx.fillRect(this.tools.drainPan.x - this.tools.drainPan.width / 2 + 5, this.tools.drainPan.y + this.tools.drainPan.height / 2 - oilDrainingLevel, this.tools.drainPan.width - 10, oilDrainingLevel);
                    }
                }

                // Embudo
                if (this.tools.funnel.placed) {
                    this.ctx.fillStyle = this.tools.funnel.color;
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.tools.funnel.x - this.tools.funnel.width / 2, this.tools.funnel.y + this.tools.funnel.height / 2);
                    this.ctx.lineTo(this.tools.funnel.x + this.tools.funnel.width / 2, this.tools.funnel.y + this.tools.funnel.height / 2);
                    this.ctx.lineTo(this.tools.funnel.x + 5, this.tools.funnel.y - this.tools.funnel.height / 2);
                    this.ctx.lineTo(this.tools.funnel.x - 5, this.tools.funnel.y - this.tools.funnel.height / 2);
                    this.ctx.closePath();
                    this.ctx.fill();

                    // Simular aceite verti√©ndose en el embudo
                    if (this.activeTool === 'newOilBottle' && this.currentStepIndex === 8 && !this.carState.newOilAdded) {
                        this.ctx.fillStyle = 'rgba(0, 255, 0, 0.7)'; // Color de aceite nuevo
                        this.ctx.beginPath();
                        this.ctx.moveTo(this.tools.funnel.x - 5, this.tools.funnel.y - this.tools.funnel.height / 2);
                        this.ctx.lineTo(this.tools.funnel.x + 5, this.tools.funnel.y - this.tools.funnel.height / 2);
                        this.ctx.lineTo(this.tools.funnel.x + 2, this.tools.funnel.y + this.tools.funnel.height / 2 - 5);
                        this.ctx.lineTo(this.tools.funnel.x - 2, this.tools.funnel.y + this.tools.funnel.height / 2 - 5);
                        this.ctx.closePath();
                        this.ctx.fill();
                    }
                }

                // Simular nivel de aceite en el c√°rter
                if (this.carState.newOilAdded && oilFillLevel > 0) {
                    this.ctx.fillStyle = 'rgba(0, 255, 0, 0.5)'; // Aceite nuevo
                    this.ctx.fillRect(this.components.oilPan.x - this.components.oilPan.width / 2 + 5, this.components.oilPan.y + this.components.oilPan.height / 2 - oilFillLevel, this.components.oilPan.width - 10, oilFillLevel);
                }

                // --- DIBUJAR RESALTADO Y ETIQUETAS ---
                this.ctx.font = '14px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';

                const drawHighlightAndLabel = (obj, isTarget = false) => {
                    const highlightColor = isTarget ? 'rgba(255, 0, 0, 0.6)' : 'rgba(255, 255, 255, 0.3)'; // Resaltado rojo
                    const labelColor = isTarget ? '#FF0000' : '#FFFFFF'; // Etiqueta roja
                    const labelOffset = isTarget ? 30 : 20;

                    this.ctx.fillStyle = highlightColor;
                    this.ctx.strokeStyle = labelColor;
                    this.ctx.lineWidth = 2;

                    if (obj.radius) { // C√≠rculo
                        this.ctx.beginPath();
                        this.ctx.arc(obj.x, obj.y, obj.radius + (isTarget ? 8 : 4), 0, Math.PI * 2);
                        this.ctx.fill();
                        this.ctx.stroke();
                        this.ctx.fillStyle = labelColor;
                        this.ctx.fillText(obj.name, obj.x, obj.y - obj.radius - labelOffset);
                    } else if (obj.width && obj.height) { // Rect√°ngulo
                        const x = obj.x - obj.width / 2;
                        const y = obj.y - obj.height / 2;
                        const padding = isTarget ? 8 : 4;
                        this.ctx.fillRect(x - padding, y - padding, obj.width + padding * 2, obj.height + padding * 2);
                        this.ctx.strokeRect(x - padding, y - padding, obj.width + padding * 2, obj.height + padding * 2);
                        this.ctx.fillStyle = labelColor;
                        this.ctx.fillText(obj.name, obj.x, y - labelOffset);
                    }
                };

                // Resaltar el objetivo del paso actual
                let targetObject = null;
                switch (targetName) {
                    case 'carBody': targetObject = this.components.carBody; break;
                    case 'drainPlug': targetObject = this.components.drainPlug; break;
                    case 'oilFilter': targetObject = this.components.oilFilter; break;
                    case 'oilCap': targetObject = this.components.oilCap; break;
                    case 'oilLevelStick': targetObject = this.components.oilLevelStick; break;
                    case 'drainPanObject': targetObject = this.tools.drainPan.placed ? this.tools.drainPan : null; break;
                    case 'funnelObject': targetObject = this.tools.funnel.placed ? this.tools.funnel : null; break;
                    case 'groundUnderCar':
                        if (this.carState.isLifted && !this.carState.drainPanPlaced) {
                            targetObject = { name: "Suelo bajo el coche", x: this.car.x, y: this.car.y + this.car.height / 2 + 20, width: this.car.width * 0.8, height: 50 };
                        }
                        break;
                    case 'oilFilterArea':
                        if (this.carState.oldFilterRemoved && !this.carState.newFilterInstalled) {
                            targetObject = { name: "√Årea del Filtro", x: this.components.oilFilter.x, y: this.components.oilFilter.y, width: this.components.oilFilter.width, height: this.components.oilFilter.height };
                        }
                        break;
                    case 'drainPlugArea':
                        if (this.carState.drainPlugRemoved && this.carState.newFilterInstalled) {
                            targetObject = { name: "√Årea del Tap√≥n", x: this.components.drainPlug.x, y: this.components.drainPlug.y, radius: this.components.drainPlug.radius };
                        }
                        break;
                }

                if (targetObject && (requiredTool === null || this.activeTool === requiredTool)) {
                    drawHighlightAndLabel(targetObject, true);
                }

                // Dibujar resaltado para el objeto sobre el que el rat√≥n est√°, si no es el objetivo principal
                if (this.hoveredObject && this.hoveredObject !== targetObject) {
                    drawHighlightAndLabel(this.hoveredObject, false);
                }

                // Dibujar etiquetas para todos los componentes relevantes si no est√°n siendo resaltados como objetivo
                [this.components.carBody, this.components.oilPan, this.components.drainPlug, this.components.oilFilter, this.components.oilCap, this.components.oilLevelStick].forEach(comp => {
                    if (comp !== targetObject && comp !== this.hoveredObject) {
                        this.ctx.fillStyle = '#FFFFFF';
                        if (comp.radius) {
                            this.ctx.fillText(comp.name, comp.x, comp.y - comp.radius - 20);
                        } else if (comp.width && comp.height) {
                            this.ctx.fillText(comp.name, comp.x, comp.y - comp.height / 2 - 20);
                        }
                    }
                });
                // Las ruedas no tienen nombre en este contexto, as√≠ que no se dibujan etiquetas para ellas.
                // this.car.wheels.forEach(wheel => {
                //     this.ctx.fillStyle = '#FFFFFF';
                //     this.ctx.fillText(wheel.name, this.car.x + wheel.xOffset, this.car.y + wheel.yOffset - wheel.radius - 15);
                // });
                if (this.tools.drainPan.placed && this.tools.drainPan !== targetObject && this.tools.drainPan !== this.hoveredObject) {
                    this.ctx.fillStyle = '#FFFFFF';
                    this.ctx.fillText(this.tools.drainPan.name, this.tools.drainPan.x, this.tools.drainPan.y - this.tools.drainPan.height / 2 - 20);
                }
                if (this.tools.funnel.placed && this.tools.funnel !== targetObject && this.tools.funnel !== this.hoveredObject) {
                    this.ctx.fillStyle = '#FFFFFF';
                    this.ctx.fillText(this.tools.funnel.name, this.tools.funnel.x, this.tools.funnel.y - this.tools.funnel.height / 2 - 20);
                }
            }
        }

        window.addEventListener('load', () => {
            new OilChangeSimulator2D();
        });
    </script>
</body>
</html>
