<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiroo - Simulador de Tráfico y Cambios de Carril</title>
    <style>
        :root {
            --primary-color: #B71C1C;
            --secondary-color: #7B1FA2;
            --accent-color: #D32F2F;
            --light-color: #121212;
            --dark-color: #000000;
            --success-color: #388E3C;
            --warning-color: #FFA000;
            --danger-color: #D32F2F;
            --text-color: #ffffff;
            --card-bg: #1e1e1e;
            --road-color: #212121;
            --lane-marking: #B0BEC5;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--light-color);
            color: var(--text-color);
            overflow-x: hidden;
        }
        
        h1 {
            color: #F44336;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #simulator-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 1200px;
        }
        
        #canvas-container {
            position: relative;
        }
        
        canvas {
            background-color: #1a1a1a;
            border: 2px solid #B71C1C;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .controls {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            width: 300px;
            border: 1px solid #B71C1C;
        }
        
        button {
            padding: 10px 15px;
            margin: 5px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            width: calc(100% - 10px);
        }
        
        button:hover {
            background-color: #7B1FA2;
        }
        
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .scenario-btn {
            background-color: var(--accent-color);
        }
        
        .scenario-btn:hover {
            background-color: #7B1FA2;
        }
        
        #instructions {
            background-color: #252525;
            padding: 15px;
            border-left: 4px solid #F44336;
            margin-top: 15px;
            border-radius: 4px;
        }
        
        .car-details {
            margin-top: 15px;
            font-size: 14px;
            color: #cccccc;
        }
        
        .progress-container {
            width: 100%;
            background-color: #333;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s;
        }
        
        #timer {
            font-weight: bold;
            color: var(--text-color);
        }
        
        .highlight {
            background-color: var(--warning-color);
            padding: 2px 5px;
            border-radius: 3px;
            animation: pulse 1.5s infinite;
            color: #000;
        }
        
        @keyframes pulse {
            0% { background-color: var(--warning-color); }
            50% { background-color: #ffc107; }
            100% { background-color: var(--warning-color); }
        }
        
        .success-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .danger-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(244, 67, 54, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        h2 {
            color: var(--text-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            margin-top: 20px;
            font-size: 18px;
        }
        
        .mirror {
            width: 80px;
            height: 40px;
            background-color: #2c3e50;
            border: 2px solid #7f8c8d;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin: 10px auto;
        }
        
        .mirror-view {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(127, 140, 141, 0.3);
            border-radius: 8px;
        }
        
        .mirror-car {
            position: absolute;
            width: 15px;
            height: 8px;
            background-color: #e74c3c;
            border-radius: 2px;
            transition: all 0.3s;
        }
        
        .dashboard {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            background-color: #252525;
            padding: 10px;
            border-radius: 5px;
        }
        
        .dashboard-item {
            text-align: center;
        }
        
        .dashboard-value {
            font-size: 18px;
            font-weight: bold;
            color: #F44336;
        }
        
        .blind-spot {
            background-color: rgba(231, 76, 60, 0.3);
            border: 1px dashed #e74c3c;
            padding: 5px;
            border-radius: 3px;
            margin-top: 5px;
            font-size: 12px;
        }
        
        .key-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        
        .key-button {
            background-color: #333;
            border: 1px solid #F44336;
            border-radius: 4px;
            padding: 8px;
            text-align: center;
            font-size: 12px;
        }
        
        .key-button kbd {
            background-color: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #F44336;
            font-family: monospace;
        }
        
        .touch-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .touch-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            font-size: 14px;
            touch-action: manipulation;
            user-select: none;
        }
        
        .touch-button:active {
            background-color: #7B1FA2;
        }
        
        @media (max-width: 768px) {
            #simulator-container {
                flex-direction: column;
                align-items: center;
            }
            
            .controls {
                width: 100%;
                max-width: 400px;
            }
            
            canvas {
                width: 100%;
                height: auto;
            }
            
            .touch-controls {
                display: grid;
            }
        }
    </style>
</head>
<body>
    <h1>Simulador de Tráfico y Cambios de Carril - Kiroo</h1>

        <div style="margin-bottom: 20px;">
    <button onclick="window.location.href='gamificación.html'" 
            style="padding: 10px 20px; background-color: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer;">
        ← Volver a Gamificación
    </button>
</div>
    
    <div id="simulator-container">
        <div id="canvas-container">
            <canvas id="trafficCanvas" width="800" height="500"></canvas>
            <div id="success-message" class="success-message">¡Cambio de Carril Exitoso!</div>
            <div id="danger-message" class="danger-message">¡Peligro! No es seguro cambiar de carril</div>
            <div id="instructions">
                <h3>Instrucciones:</h3>
                <p id="current-instruction">Selecciona un escenario para comenzar. Usa las teclas para controlar el vehículo.</p>
                <div class="dashboard">
                    <div class="dashboard-item">
                        <div>Velocidad</div>
                        <div id="speed-display" class="dashboard-value">60 km/h</div>
                    </div>
                    <div class="dashboard-item">
                        <div>Distancia</div>
                        <div id="distance-display" class="dashboard-value">30 m</div>
                    </div>
                    <div class="dashboard-item">
                        <div>Indicador</div>
                        <div id="indicator-display" class="dashboard-value">OFF</div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-around; margin-top: 10px;">
                    <div>
                        <div>Espejo retrovisor</div>
                        <div class="mirror">
                            <div class="mirror-view">
                                <div id="mirror-car" class="mirror-car" style="right: 5px; top: 16px;"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div>Ángulo muerto</div>
                        <div class="blind-spot" id="blind-spot-indicator">
                            Sin vehículos
                        </div>
                    </div>
                </div>
                <div class="car-details">
                    <div>Tiempo: <span id="timer">00:00</span></div>
                    <div class="progress-container">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <h2>Escenarios de Tráfico</h2>
            <button id="highway" class="scenario-btn">Autopista</button>
            <button id="city" class="scenario-btn">Ciudad</button>
            <button id="merging" class="scenario-btn">Incorporación</button>
            <button id="overtaking" class="scenario-btn">Adelantamiento</button>
            <button id="heavyTraffic" class="scenario-btn">Tráfico denso</button>
            <button id="adverseWeather" class="scenario-btn">Clima adverso</button>
            
            <h2 id="scenario-title" style="margin-top: 20px;">Selecciona un escenario</h2>
            
            <div class="key-controls">
                <div class="key-button">Señalizar izquierda<br><kbd>A</kbd></div>
                <div class="key-button">Señalizar derecha<br><kbd>D</kbd></div>
                <div class="key-button">Cambiar carril<br><kbd>ESPACIO</kbd></div>
                <div class="key-button">Acelerar<br><kbd>W</kbd> / <kbd>↑</kbd></div>
                <div class="key-button">Desacelerar<br><kbd>S</kbd> / <kbd>↓</kbd></div>
                <div class="key-button">Reiniciar<br><kbd>R</kbd></div>
            </div>
            
            <div class="touch-controls">
                <button class="touch-button" id="touch-left">Señal Izq</button>
                <button class="touch-button" id="touch-right">Señal Der</button>
                <button class="touch-button" id="touch-change">Cambiar Carril</button>
                <button class="touch-button" id="touch-accelerate">Acelerar</button>
                <button class="touch-button" id="touch-decelerate">Desacelerar</button>
                <button class="touch-button" id="touch-reset">Reiniciar</button>
            </div>
            
            <button id="reset-scenario">Reiniciar escenario actual</button>
        </div>
    </div>

<script>
    // Configuración del canvas
    const canvas = document.getElementById('trafficCanvas');
    const ctx = canvas.getContext('2d');
    
    // Ajustar tamaño del canvas si es necesario
    canvas.width = 800;
    canvas.height = 500;
    
    // Elementos de la interfaz
    const scenarioTitle = document.getElementById('scenario-title');
    const speedDisplay = document.getElementById('speed-display');
    const distanceDisplay = document.getElementById('distance-display');
    const indicatorDisplay = document.getElementById('indicator-display');
    const timerDisplay = document.getElementById('timer');
    const progressBar = document.getElementById('progress-bar');
    const currentInstruction = document.getElementById('current-instruction');
    const successMessage = document.getElementById('success-message');
    const dangerMessage = document.getElementById('danger-message');
    const mirrorCar = document.getElementById('mirror-car');
    const blindSpotIndicator = document.getElementById('blind-spot-indicator');
    const resetBtn = document.getElementById('reset-scenario');
    
    // Estados del simulador
    const TrafficScenario = {
        HIGHWAY: 1,
        CITY: 2,
        MERGING: 3,
        OVERTAKING: 4,
        HEAVY_TRAFFIC: 5,
        ADVERSE_WEATHER: 6
    };
    
    // Variables del juego
    let playerCar = {
        x: canvas.width / 2,
        y: canvas.height - 100,
        lane: 1, // 0: izquierda, 1: centro, 2: derecha
        width: 40,
        height: 20,
        speed: 60, // km/h
        targetX: canvas.width / 2,
        changingLane: false,
        laneChangeDirection: 0, // -1: izquierda, 0: ninguna, 1: derecha
        turnSignal: 0, // -1: izquierda, 0: ninguna, 1: derecha
        color: '#F44336'
    };
    
    let trafficCars = [];
    let road = {
        width: canvas.width,
        laneWidth: canvas.width / 3,
        laneCount: 3,
        markings: []
    };
    
    // Inicializar marcas viales
    for (let i = 0; i < 20; i++) {
        road.markings.push({
            x: canvas.width / 2 - 5,
            y: i * 50,
            width: 10,
            height: 5
        });
    }
    
    let currentScenario = null;
    let timeElapsed = 0;
    let timerInterval;

    // Prevenir el comportamiento por defecto de las teclas para evitar scroll
    const preventScrollKeys = [' ', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
    
    // Event listeners para teclado
    document.addEventListener('keydown', handleKeyDown);
    
    // Prevenir scroll con las teclas de control
    document.addEventListener('keydown', function(e) {
        if (preventScrollKeys.includes(e.key)) {
            e.preventDefault();
        }
    });
    
    function handleKeyDown(e) {
        if (!currentScenario) return;
        
        switch(e.key.toLowerCase()) {
            case 'a':
                activateTurnSignal(-1);
                break;
            case 'd':
                activateTurnSignal(1);
                break;
            case ' ':
                e.preventDefault(); // Prevenir scroll con espacio
                attemptLaneChange();
                break;
            case 'w':
            case 'arrowup':
                e.preventDefault(); // Prevenir scroll con flechas
                adjustSpeed(5);
                break;
            case 's':
            case 'arrowdown':
                e.preventDefault(); // Prevenir scroll con flechas
                adjustSpeed(-5);
                break;
            case 'r':
                resetScenario();
                break;
        }
    }
    
    // Controles táctiles
    document.getElementById('touch-left').addEventListener('click', () => activateTurnSignal(-1));
    document.getElementById('touch-right').addEventListener('click', () => activateTurnSignal(1));
    document.getElementById('touch-change').addEventListener('click', attemptLaneChange);
    document.getElementById('touch-accelerate').addEventListener('click', () => adjustSpeed(5));
    document.getElementById('touch-decelerate').addEventListener('click', () => adjustSpeed(-5));
    document.getElementById('touch-reset').addEventListener('click', resetScenario);
    
    // Botones de escenarios - CORREGIDO: Ahora se pueden cambiar en cualquier momento
    document.getElementById('highway').addEventListener('click', () => {
        createScenario(TrafficScenario.HIGHWAY);
    });
    document.getElementById('city').addEventListener('click', () => {
        createScenario(TrafficScenario.CITY);
    });
    document.getElementById('merging').addEventListener('click', () => {
        createScenario(TrafficScenario.MERGING);
    });
    document.getElementById('overtaking').addEventListener('click', () => {
        createScenario(TrafficScenario.OVERTAKING);
    });
    document.getElementById('heavyTraffic').addEventListener('click', () => {
        createScenario(TrafficScenario.HEAVY_TRAFFIC);
    });
    document.getElementById('adverseWeather').addEventListener('click', () => {
        createScenario(TrafficScenario.ADVERSE_WEATHER);
    });
    
    resetBtn.addEventListener('click', resetScenario);
    
    function activateTurnSignal(direction) {
        playerCar.turnSignal = direction;
        updateIndicatorDisplay();
    }
    
    function attemptLaneChange() {
        if (playerCar.turnSignal === 0) {
            currentInstruction.innerHTML = "<span class='highlight'>Primero señaliza</span> la dirección del cambio de carril.";
            showDangerMessage("¡Señaliza primero!");
            return;
        }
        
        if (playerCar.changingLane) {
            currentInstruction.innerHTML = "Ya estás cambiando de carril.";
            return;
        }
        
        const direction = playerCar.turnSignal;
        const newLane = playerCar.lane + direction;
        
        if (newLane < 0 || newLane > 2) {
            currentInstruction.innerHTML = "No hay más carriles en esa dirección.";
            showDangerMessage("¡No hay más carriles!");
            return;
        }
        
        // Verificar si es seguro cambiar de carril
        if (isLaneChangeSafe(newLane)) {
            playerCar.changingLane = true;
            playerCar.laneChangeDirection = direction;
            playerCar.targetX = (newLane * road.laneWidth) + (road.laneWidth / 2);
            currentInstruction.innerHTML = "Cambiando de carril. Mantén la velocidad constante.";
        } else {
            currentInstruction.innerHTML = "<span class='highlight'>¡Peligro!</span> No es seguro cambiar de carril. Espera a que haya espacio.";
            showDangerMessage("¡Peligro! No es seguro");
        }
    }
    
    function isLaneChangeSafe(newLane) {
        const playerY = playerCar.y;
        const safetyDistance = 100; // Distancia de seguridad en píxeles
        
        for (const car of trafficCars) {
            // Verificar si hay coches en el carril objetivo
            if (car.lane === newLane) {
                // Verificar distancia frontal y trasera
                const distance = Math.abs(car.y - playerY);
                if (distance < safetyDistance) {
                    return false;
                }
            }
            
            // Verificar coches en carril adyacente que puedan estar en punto ciego
            if (car.lane === playerCar.lane && Math.abs(car.y - playerY) < 50) {
                return false;
            }
        }
        
        return true;
    }
    
    function adjustSpeed(amount) {
        playerCar.speed = Math.max(30, Math.min(120, playerCar.speed + amount));
        updateSpeedDisplay();
    }
    
    function updateSpeedDisplay() {
        speedDisplay.textContent = `${playerCar.speed} km/h`;
    }
    
    function updateIndicatorDisplay() {
        indicatorDisplay.textContent = 
            playerCar.turnSignal === -1 ? "IZQ" :
            playerCar.turnSignal === 1 ? "DER" : "OFF";
            
        indicatorDisplay.style.color = 
            playerCar.turnSignal !== 0 ? "#FF9800" : "#F44336";
    }
    
    function showSuccessMessage() {
        successMessage.style.display = 'block';
        setTimeout(() => {
            successMessage.style.display = 'none';
        }, 2000);
    }
    
    function showDangerMessage(message) {
        dangerMessage.textContent = message;
        dangerMessage.style.display = 'block';
        setTimeout(() => {
            dangerMessage.style.display = 'none';
        }, 2000);
    }
    
    // Función para crear escenarios - CORREGIDA
    function createScenario(scenarioType) {
        // Limpiar el escenario actual
        clearInterval(timerInterval);
        trafficCars = [];
        
        currentScenario = scenarioType;
        
        // Configurar estado inicial del vehículo del jugador
        playerCar = {
            x: canvas.width / 2,
            y: canvas.height - 100,
            lane: 1,
            width: 40,
            height: 20,
            speed: 60,
            targetX: canvas.width / 2,
            changingLane: false,
            laneChangeDirection: 0,
            turnSignal: 0,
            color: '#F44336'
        };
        
        // Configurar según el escenario
        switch(scenarioType) {
            case TrafficScenario.HIGHWAY:
                scenarioTitle.textContent = "Conducción en Autopista";
                
                // Crear tráfico para autopista
                trafficCars = [
                    { x: road.laneWidth / 2, y: canvas.height - 200, lane: 0, speed: 90, width: 40, height: 20, color: '#9C27B0' },
                    { x: road.laneWidth / 2, y: canvas.height - 350, lane: 0, speed: 95, width: 40, height: 20, color: '#7B1FA2' },
                    { x: canvas.width / 2, y: canvas.height - 280, lane: 1, speed: 100, width: 40, height: 20, color: '#E91E63' },
                    { x: (road.laneWidth * 2) + (road.laneWidth / 2), y: canvas.height - 150, lane: 2, speed: 110, width: 40, height: 20, color: '#C2185B' }
                ];
                break;
                
            case TrafficScenario.CITY:
                scenarioTitle.textContent = "Conducción en Ciudad";
                playerCar.speed = 50;
                
                // Crear tráfico para ciudad
                trafficCars = [
                    { x: road.laneWidth / 2, y: canvas.height - 180, lane: 0, speed: 45, width: 40, height: 20, color: '#9C27B0' },
                    { x: canvas.width / 2, y: canvas.height - 250, lane: 1, speed: 50, width: 40, height: 20, color: '#E91E63' },
                    { x: canvas.width / 2, y: canvas.height - 400, lane: 1, speed: 48, width: 40, height: 20, color: '#7B1FA2' },
                    { x: (road.laneWidth * 2) + (road.laneWidth / 2), y: canvas.height - 300, lane: 2, speed: 52, width: 40, height: 20, color: '#C2185B' }
                ];
                break;
                
            case TrafficScenario.MERGING:
                scenarioTitle.textContent = "Incorporación a Autopista";
                
                // Crear tráfico para incorporación
                trafficCars = [
                    { x: road.laneWidth / 2, y: canvas.height - 180, lane: 0, speed: 90, width: 40, height: 20, color: '#9C27B0' },
                    { x: canvas.width / 2, y: canvas.height - 250, lane: 1, speed: 100, width: 40, height: 20, color: '#E91E63' },
                    { x: (road.laneWidth * 2) + (road.laneWidth / 2), y: canvas.height - 300, lane: 2, speed: 95, width: 40, height: 20, color: '#C2185B' },
                    { x: (road.laneWidth * 2) + (road.laneWidth / 2), y: canvas.height - 450, lane: 2, speed: 105, width: 40, height: 20, color: '#7B1FA2' }
                ];
                break;
                
            case TrafficScenario.OVERTAKING:
                scenarioTitle.textContent = "Adelantamiento";
                
                // Crear tráfico para adelantamiento
                trafficCars = [
                    { x: canvas.width / 2, y: canvas.height - 150, lane: 1, speed: 80, width: 40, height: 20, color: '#9C27B0' },
                    { x: road.laneWidth / 2, y: canvas.height - 300, lane: 0, speed: 100, width: 40, height: 20, color: '#E91E63' },
                    { x: (road.laneWidth * 2) + (road.laneWidth / 2), y: canvas.height - 400, lane: 2, speed: 95, width: 40, height: 20, color: '#C2185B' }
                ];
                break;
                
            case TrafficScenario.HEAVY_TRAFFIC:
                scenarioTitle.textContent = "Tráfico Denso";
                playerCar.speed = 40;
                
                // Crear tráfico denso
                trafficCars = [
                    { x: road.laneWidth / 2, y: canvas.height - 120, lane: 0, speed: 35, width: 40, height: 20, color: '#9C27B0' },
                    { x: canvas.width / 2, y: canvas.height - 180, lane: 1, speed: 40, width: 40, height: 20, color: '#E91E63' },
                    { x: (road.laneWidth * 2) + (road.laneWidth / 2), y: canvas.height - 150, lane: 2, speed: 38, width: 40, height: 20, color: '#C2185B' },
                    { x: road.laneWidth / 2, y: canvas.height - 300, lane: 0, speed: 42, width: 40, height: 20, color: '#7B1FA2' },
                    { x: canvas.width / 2, y: canvas.height - 350, lane: 1, speed: 37, width: 40, height: 20, color: '#D81B60' },
                    { x: (road.laneWidth * 2) + (road.laneWidth / 2), y: canvas.height - 400, lane: 2, speed: 39, width: 40, height: 20, color: '#AD1457' }
                ];
                break;
                
            case TrafficScenario.ADVERSE_WEATHER:
                scenarioTitle.textContent = "Clima Adverso";
                playerCar.speed = 50;
                
                // Crear tráfico para clima adverso
                trafficCars = [
                    { x: road.laneWidth / 2, y: canvas.height - 200, lane: 0, speed: 45, width: 40, height: 20, color: '#9C27B0' },
                    { x: canvas.width / 2, y: canvas.height - 280, lane: 1, speed: 50, width: 40, height: 20, color: '#E91E63' },
                    { x: (road.laneWidth * 2) + (road.laneWidth / 2), y: canvas.height - 350, lane: 2, speed: 48, width: 40, height: 20, color: '#C2185B' }
                ];
                break;
        }
        
        updateSpeedDisplay();
        updateIndicatorDisplay();
        
        // Iniciar temporizador
        startTimer();
        
        // Actualizar instrucción actual
        currentInstruction.innerHTML = "Usa las teclas para controlar el vehículo. <span class='highlight'>A</span> izquierda, <span class='highlight'>D</span> derecha, <span class='highlight'>ESPACIO</span> cambiar carril.";
    }
    
    function resetScenario() {
        if (currentScenario) {
            createScenario(currentScenario);
        } else {
            // Si no hay escenario seleccionado, seleccionar autopista por defecto
            createScenario(TrafficScenario.HIGHWAY);
        }
    }
    
    function startTimer() {
        clearInterval(timerInterval);
        timeElapsed = 0;
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            timeElapsed++;
            updateTimerDisplay();
        }, 1000);
    }
    
    function updateTimerDisplay() {
        const minutes = Math.floor(timeElapsed / 60);
        const seconds = timeElapsed % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Función para actualizar el estado del simulador
    function updateSimulation() {
        // Mover el coche del jugador durante el cambio de carril
        if (playerCar.changingLane) {
            const dx = playerCar.targetX - playerCar.x;
            playerCar.x += dx * 0.05;
            
            if (Math.abs(dx) < 2) {
                playerCar.x = playerCar.targetX;
                playerCar.changingLane = false;
                playerCar.lane += playerCar.laneChangeDirection;
                playerCar.laneChangeDirection = 0;
                playerCar.turnSignal = 0;
                updateIndicatorDisplay();
                
                showSuccessMessage();
                currentInstruction.innerHTML = "Cambio de carril completado con éxito.";
            }
        }
        
        // Actualizar posición de las marcas viales
        for (let i = 0; i < road.markings.length; i++) {
            road.markings[i].y += playerCar.speed / 20;
            
            if (road.markings[i].y > canvas.height) {
                road.markings[i].y = -20;
            }
        }
        
        // Actualizar posición de los coches de tráfico
        for (let i = 0; i < trafficCars.length; i++) {
            const car = trafficCars[i];
            car.y += (car.speed - playerCar.speed) / 20;
            
            // Si el coche sale de la pantalla por abajo, lo reposicionamos arriba
            if (car.y > canvas.height + 100) {
                car.y = -100;
                car.lane = Math.floor(Math.random() * 3);
                car.x = (car.lane * road.laneWidth) + (road.laneWidth / 2);
            }
            
            // Si el coche sale de la pantalla por arriba, lo reposicionamos abajo
            if (car.y < -100) {
                car.y = canvas.height + 100;
                car.lane = Math.floor(Math.random() * 3);
                car.x = (car.lane * road.laneWidth) + (road.laneWidth / 2);
            }
        }
        
        // Actualizar información del espejo retrovisor
        updateMirrorInfo();
    }
    
    function updateMirrorInfo() {
        // Encontrar el coche más cercano en el carril trasero
        let closestCar = null;
        let minDistance = Infinity;
        
        for (const car of trafficCars) {
            if (car.lane === playerCar.lane && car.y > playerCar.y) {
                const distance = car.y - playerCar.y;
                if (distance < minDistance) {
                    minDistance = distance;
                    closestCar = car;
                }
            }
        }
        
        // Actualizar el espejo retrovisor
        if (closestCar) {
            const distance = Math.min(300, minDistance);
            const position = (distance / 300) * 70; // Escalar a posición en el espejo
            mirrorCar.style.top = `${16 + position}px`;
            mirrorCar.style.display = 'block';
            
            // Actualizar indicador de distancia
            distanceDisplay.textContent = `${Math.round(minDistance / 5)} m`;
            
            // Actualizar ángulo muerto
            if (minDistance < 50) {
                blindSpotIndicator.textContent = "¡Vehículo cercano!";
                blindSpotIndicator.style.backgroundColor = "rgba(231, 76, 60, 0.5)";
            } else {
                blindSpotIndicator.textContent = "Sin vehículos";
                blindSpotIndicator.style.backgroundColor = "rgba(46, 204, 113, 0.3)";
            }
        } else {
            mirrorCar.style.display = 'none';
            distanceDisplay.textContent = "--- m";
            blindSpotIndicator.textContent = "Sin vehículos";
            blindSpotIndicator.style.backgroundColor = "rgba(46, 204, 113, 0.3)";
        }
    }
    
    // Función para dibujar el simulador
    function drawSimulation() {
        // Limpiar el canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Dibujar la carretera
        ctx.fillStyle = '#212121';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Dibujar los carriles
        for (let i = 1; i < road.laneCount; i++) {
            ctx.setLineDash([15, 15]);
            ctx.beginPath();
            ctx.moveTo(i * road.laneWidth, 0);
            ctx.lineTo(i * road.laneWidth, canvas.height);
            ctx.strokeStyle = '#B0BEC5';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        // Dibujar marcas viales
        ctx.setLineDash([]);
        for (const marking of road.markings) {
            ctx.fillStyle = '#B0BEC5';
            ctx.fillRect(marking.x, marking.y, marking.width, marking.height);
        }
        
        // Dibujar coches de tráfico
        for (const car of trafficCars) {
            ctx.fillStyle = car.color;
            ctx.fillRect(car.x - car.width / 2, car.y - car.height / 2, car.width, car.height);
            
            // Detalles del coche
            ctx.fillStyle = '#000000';
            ctx.fillRect(car.x - car.width / 4, car.y - car.height / 2 - 2, car.width / 2, 2); // Parabrisas
            ctx.fillRect(car.x - car.width / 4, car.y + car.height / 2, car.width / 2, 2); // Parte trasera
            
            // Luces
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(car.x - car.width / 2 + 2, car.y - 3, 2, 2); // Luz delantera izquierda
            ctx.fillRect(car.x + car.width / 2 - 4, car.y - 3, 2, 2); // Luz delantera derecha
            
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(car.x - car.width / 2 + 2, car.y + 1, 2, 2); // Luz trasera izquierda
            ctx.fillRect(car.x + car.width / 2 - 4, car.y + 1, 2, 2); // Luz trasera derecha
        }
        
        // Dibujar coche del jugador
        ctx.fillStyle = playerCar.color;
        ctx.fillRect(playerCar.x - playerCar.width / 2, playerCar.y - playerCar.height / 2, playerCar.width, playerCar.height);
        
        // Detalles del coche del jugador
        ctx.fillStyle = '#000000';
        ctx.fillRect(playerCar.x - playerCar.width / 4, playerCar.y - playerCar.height / 2 - 2, playerCar.width / 2, 2); // Parabrisas
        ctx.fillRect(playerCar.x - playerCar.width / 4, playerCar.y + playerCar.height / 2, playerCar.width / 2, 2); // Parte trasera
        
        // Luces del coche del jugador
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(playerCar.x - playerCar.width / 2 + 2, playerCar.y - 3, 2, 2); // Luz delantera izquierda
        ctx.fillRect(playerCar.x + playerCar.width / 2 - 4, playerCar.y - 3, 2, 2); // Luz delantera derecha
        
        ctx.fillStyle = '#FF0000';
        ctx.fillRect(playerCar.x - playerCar.width / 2 + 2, playerCar.y + 1, 2, 2); // Luz trasera izquierda
        ctx.fillRect(playerCar.x + playerCar.width / 2 - 4, playerCar.y + 1, 2, 2); // Luz trasera derecha
        
        // Dibujar intermitentes si están activados
        if (playerCar.turnSignal !== 0) {
            ctx.fillStyle = '#FF9800';
            if (playerCar.turnSignal === -1) { // Intermitente izquierdo
                ctx.fillRect(playerCar.x - playerCar.width / 2 - 5, playerCar.y - 2, 3, 4);
            } else { // Intermitente derecho
                ctx.fillRect(playerCar.x + playerCar.width / 2 + 2, playerCar.y - 2, 3, 4);
            }
        }
    }
    
    // Bucle principal del simulador
    function gameLoop() {
        updateSimulation();
        drawSimulation();
        requestAnimationFrame(gameLoop);
    }
    
    // Iniciar el bucle del juego
    gameLoop();
    
    // Iniciar con un escenario por defecto
    createScenario(TrafficScenario.HIGHWAY);
</script>
</body>
</html>